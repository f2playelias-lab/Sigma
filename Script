-- Phox Helper — Retro Arcade Red dropdown (draggable) 
-- LocalScript -> StarterPlayer > StarterPlayerScripts

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
repeat task.wait() until player and player:FindFirstChild("PlayerGui")
local playerGui = player:WaitForChild("PlayerGui")

-- remove previous UI
if playerGui:FindFirstChild("PHOX_HELPER_UI") then
    playerGui.PHOX_HELPER_UI:Destroy()
end

-- Style constants
local WIDTH, HEADER_H, ITEM_H = 300, 64, 36
local BG = Color3.fromRGB(18,18,18)
local ACCENT = Color3.fromRGB(200,20,28)
local ACCENT_DARK = Color3.fromRGB(120,8,10)
local BTN_BG = Color3.fromRGB(34,34,34)
local TOGGLE_ON = Color3.fromRGB(0,200,80)
local TOGGLE_OFF = Color3.fromRGB(220,220,220)

-- Create ScreenGui
local SG = Instance.new("ScreenGui")
SG.Name = "PHOX_HELPER_UI"
SG.IgnoreGuiInset = true
SG.ResetOnSpawn = false
SG.DisplayOrder = 9999
SG.Parent = playerGui

-- Window (starts collapsed)
local window = Instance.new("Frame")
window.Name = "Window"
window.Size = UDim2.new(0, WIDTH, 0, HEADER_H)
window.Position = UDim2.new(0.5, -WIDTH/2, 0.5, -HEADER_H/2)
window.AnchorPoint = Vector2.new(0.5,0.5)
window.BackgroundColor3 = BG
window.BorderSizePixel = 0
window.Parent = SG

-- Outline border
local border = Instance.new("UIStroke")
border.Parent = window
border.Color = ACCENT
border.Thickness = 2
border.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

-- Title bar (draggable area)
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1,0,0,HEADER_H)
titleBar.Position = UDim2.new(0,0,0,0)
titleBar.BackgroundColor3 = ACCENT
titleBar.BorderSizePixel = 0
titleBar.Parent = window

local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "TitleLabel"
titleLabel.Size = UDim2.new(1, -64, 1, 0) -- leave space for toggle button on right
titleLabel.Position = UDim2.new(0, 12, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Font = Enum.Font.Arcade
titleLabel.Text = "Phox Helper"
titleLabel.TextSize = 26
titleLabel.TextColor3 = Color3.new(1,1,1)
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.TextYAlignment = Enum.TextYAlignment.Center
titleLabel.Parent = titleBar

-- pixel outline clones for title
local offsets = {
    Vector2.new(-1,0), Vector2.new(1,0),
    Vector2.new(0,-1), Vector2.new(0,1),
    Vector2.new(-1,-1), Vector2.new(1,-1),
    Vector2.new(-1,1), Vector2.new(1,1)
}
for _,off in ipairs(offsets) do
    local s = titleLabel:Clone()
    s.TextColor3 = Color3.new(0,0,0)
    s.ZIndex = 2
    s.Position = UDim2.new(0, 12 + off.X, 0, off.Y)
    s.Parent = titleBar
end

-- Toggle Options small button on the right of title (opens dropdown)
local toggleOptionsBtn = Instance.new("TextButton")
toggleOptionsBtn.Name = "ToggleOptionsBtn"
toggleOptionsBtn.Size = UDim2.new(0, 48, 0, 28)
toggleOptionsBtn.Position = UDim2.new(1, -56, 0, 18)
toggleOptionsBtn.AnchorPoint = Vector2.new(0,0)
toggleOptionsBtn.BackgroundColor3 = BTN_BG
toggleOptionsBtn.BorderSizePixel = 0
toggleOptionsBtn.Font = Enum.Font.Arcade
toggleOptionsBtn.Text = "Menu"
toggleOptionsBtn.TextSize = 16
toggleOptionsBtn.TextColor3 = Color3.new(1,1,1)
toggleOptionsBtn.Parent = titleBar
local toggleStroke = Instance.new("UIStroke", toggleOptionsBtn)
toggleStroke.Color = ACCENT
toggleStroke.Thickness = 2

-- Small expand indicator near it
local expandLabel = Instance.new("TextLabel")
expandLabel.Size = UDim2.new(0, 20, 0, 20)
expandLabel.Position = UDim2.new(1, -28, 0, 22)
expandLabel.BackgroundTransparency = 1
expandLabel.Font = Enum.Font.Arcade
expandLabel.Text = "+"
expandLabel.TextSize = 18
expandLabel.TextColor3 = Color3.new(1,1,1)
expandLabel.Parent = titleBar

-- Content (dropdown) frame directly under title bar
local content = Instance.new("Frame")
content.Name = "Content"
content.Size = UDim2.new(1,0,0,0) -- collapsed; we'll set size after building buttons
content.Position = UDim2.new(0,0,1,0)
content.BackgroundColor3 = BG
content.BorderSizePixel = 0
content.Parent = window

local contentStroke = toggleStroke:Clone()
contentStroke.Parent = content
contentStroke.Thickness = 1

-- Helper to create pixel button
local function makeButton(parent, labelText, y)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -16, 0, ITEM_H)
    btn.Position = UDim2.new(0, 8, 0, y)
    btn.BackgroundColor3 = BTN_BG
    btn.BorderSizePixel = 0
    btn.AutoButtonColor = false
    btn.Font = Enum.Font.Arcade
    btn.Text = labelText
    btn.TextSize = 16
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Parent = parent
    local s = Instance.new("UIStroke", btn)
    s.Color = ACCENT
    s.Thickness = 2
    return btn, s
end

-- Toggle box helper (small square on right)
local function createToggleBox(parent)
    local box = Instance.new("Frame")
    box.Size = UDim2.new(0, 18, 0, 18)
    box.Position = UDim2.new(1, -34, 0.5, -9)
    box.BackgroundColor3 = TOGGLE_OFF
    box.BorderSizePixel = 0
    box.Parent = parent
    local bs = Instance.new("UIStroke", box)
    bs.Color = Color3.fromRGB(32,32,32)
    bs.Thickness = 1
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new(1, -6, 1, -6)
    fill.Position = UDim2.new(0, 3, 0, 3)
    fill.BackgroundColor3 = TOGGLE_ON
    fill.Visible = false
    fill.Parent = box
    Instance.new("UICorner", fill).CornerRadius = UDim.new(0,2)
    return box, fill
end

-- Options list (placeholders first 3)
local options = {
    "Los Puggies",       -- placeholder
    "Los Spaghettis",    -- placeholder
    "Fragama",           -- placeholder
    "Plataforma V2",     -- toggle (working)
    "Inf Jump",          -- toggle (working)
    "ESP All",           -- toggle (working)
    "Same Time Scam"     -- action (fires remote)
}

-- Build buttons
local toggled = {}
local buttons = {}
for i,name in ipairs(options) do
    toggled[name] = false
end

-- Setup content Size based on options
content.Size = UDim2.new(1,0,0,#options * ITEM_H + 12)
-- small padding frame
local pad = Instance.new("Frame")
pad.Size = UDim2.new(1,0,0,8)
pad.BackgroundTransparency = 1
pad.Parent = content

-- PLATFORM (Plataforma V2) variables
local PLATFORM_SIZE = Vector3.new(6,1,6)
local OFFSET_BELOW = 3
local platformPart = nil
local platformHB = nil          -- heartbeat connection
local platformCharConn = nil    -- character added connection

local function createPlatformForChar(char)
    if platformPart and platformPart.Parent then return platformPart end
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local p = Instance.new("Part")
    p.Name = "Phox_Platform"
    p.Size = PLATFORM_SIZE
    p.Anchored = true
    p.CanCollide = true
    p.Material = Enum.Material.Neon
    p.Transparency = 0.15
    p.Color = Color3.fromRGB(150, 0, 0)
    p.CFrame = hrp.CFrame * CFrame.new(0, -OFFSET_BELOW - PLATFORM_SIZE.Y/2, 0)
    p.Parent = Workspace
    platformPart = p
    return p
end

local function startPlatformFollow(char)
    if platformHB then return end
    platformHB = RunService.Heartbeat:Connect(function()
        if not platformPart or not platformPart.Parent then return end
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        platformPart.CFrame = CFrame.new(hrp.Position - Vector3.new(0, OFFSET_BELOW, 0))
    end)
end

local function stopPlatform()
    if platformPart then
        pcall(function() platformPart:Destroy() end)
        platformPart = nil
    end
    if platformHB then
        platformHB:Disconnect()
        platformHB = nil
    end
    if platformCharConn then
        pcall(function() platformCharConn:Disconnect() end)
        platformCharConn = nil
    end
end

-- INF JUMP variables
local UIS = game:GetService("UserInputService")
local infJumpActive = false
local infGrav = nil
local infJumpConn = nil
local infCharConn = nil

local function enableInfJumpForChar(char)
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    if not infGrav then
        local att = Instance.new("Attachment")
        att.Name = "PhoxInfJumpAttachment"
        att.Parent = hrp
        infGrav = Instance.new("VectorForce")
        infGrav.Attachment0 = att
        infGrav.RelativeTo = Enum.ActuatorRelativeTo.World
        infGrav.Force = Vector3.new(0, Workspace.Gravity * hrp.AssemblyMass * 0.8, 0)
        infGrav.Parent = hrp
    end
    if not infJumpConn then
        infJumpConn = UIS.JumpRequest:Connect(function()
            if hrp and hrp.Parent then
                local v = hrp.AssemblyLinearVelocity
                hrp.AssemblyLinearVelocity = Vector3.new(v.X, 40, v.Z)
            end
        end)
    end
end

local function disableInfJump()
    if infGrav then pcall(function() infGrav:Destroy() end) infGrav = nil end
    if infJumpConn then infJumpConn:Disconnect() infJumpConn = nil end
    if infCharConn then pcall(function() infCharConn:Disconnect() end) infCharConn = nil end
end

-- ESP variables
local ESPActive = false
local espHighlights = {}
local espBillboards = {}
local playersAddedConn = nil
local charsConnList = {}

local function createESPForCharacter(char)
    if not char or not char:FindFirstChild("Head") then return end
    -- avoid duplicates
    for _,h in ipairs(espHighlights) do
        if h.Adornee == char then return end
    end
    local hl = Instance.new("Highlight")
    hl.Adornee = char
    hl.FillColor = Color3.fromRGB(255,90,90)
    hl.OutlineColor = Color3.fromRGB(255,50,50)
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = char
    table.insert(espHighlights, hl)

    local head = char:FindFirstChild("Head")
    if head then
        local bb = Instance.new("BillboardGui")
        bb.Adornee = head
        bb.Size = UDim2.new(0,120,0,36)
        bb.StudsOffset = Vector3.new(0, 2.2, 0)
        bb.AlwaysOnTop = true
        bb.Parent = char
        local lbl = Instance.new("TextLabel", bb)
        lbl.Size = UDim2.new(1,0,1,0)
        lbl.BackgroundTransparency = 1
        lbl.Font = Enum.Font.Arcade
        lbl.Text = char.Name
        lbl.TextColor3 = Color3.fromRGB(255,200,200)
        lbl.TextScaled = true
        lbl.TextStrokeTransparency = 0.6
        table.insert(espBillboards, bb)
    end
end

local function enableESP()
    ESPActive = true
    for _,pl in ipairs(Players:GetPlayers()) do
        if pl ~= player and pl.Character then
            createESPForCharacter(pl.Character)
        end
    end
    playersAddedConn = Players.PlayerAdded:Connect(function(pl)
        local conn
        conn = pl.CharacterAdded:Connect(function(ch)
            if ESPActive then createESPForCharacter(ch) end
        end)
        table.insert(charsConnList, conn)
    end)
    -- also listen for respawns on existing players
    for _,pl in ipairs(Players:GetPlayers()) do
        local conn2 = pl.CharacterAdded:Connect(function(ch)
            if ESPActive then createESPForCharacter(ch) end
        end)
        table.insert(charsConnList, conn2)
    end
end

local function disableESP()
    ESPActive = false
    for _,h in ipairs(espHighlights) do pcall(function() h:Destroy() end) end
    for _,b in ipairs(espBillboards) do pcall(function() b:Destroy() end) end
    espHighlights = {}
    espBillboards = {}
    if playersAddedConn then pcall(function() playersAddedConn:Disconnect() end) playersAddedConn = nil end
    for _,c in ipairs(charsConnList) do pcall(function() c:Disconnect() end) end
    charsConnList = {}
end

-- Create UI elements and wire logic
local yOffset = 8
for i, name in ipairs(options) do
    local btn, stroke = makeButton(content, name, yOffset)
    buttons[name] = btn

    local toggleFill = nil
    if name ~= "Same Time Scam" then
        local box, fill = createToggleBox(btn)
        toggleFill = fill
    end

    -- hover effect
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.06), {BackgroundColor3 = Color3.fromRGB(44,44,44)}):Play()
        TweenService:Create(stroke, TweenInfo.new(0.08), {Thickness = 3}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.12), {BackgroundColor3 = BTN_BG}):Play()
        TweenService:Create(stroke, TweenInfo.new(0.12), {Thickness = 2}):Play()
    end)

    btn.MouseButton1Click:Connect(function()
        if name == "Same Time Scam" then
            local ok, remote = pcall(function()
                return ReplicatedStorage.Packages and ReplicatedStorage.Packages:FindFirstChild("Net") and ReplicatedStorage.Packages.Net:FindFirstChild("RE/PlotService/ToggleFriends")
            end)
            if ok and remote then
                pcall(function() remote:FireServer() end)
            else
                warn("Remote not found: ReplicatedStorage.Packages.Net['RE/PlotService/ToggleFriends']")
            end
            return
        end

        -- toggle state
        toggled[name] = not toggled[name]
        if toggleFill then toggleFill.Visible = toggled[name] end

        if name == "Plataforma V2" then
            if toggled[name] then
                local char = player.Character or player.CharacterAdded:Wait()
                createPlatformForChar(char)
                startPlatformFollow(char)
                -- reapply on respawn
                platformCharConn = player.CharacterAdded:Connect(function(newChar)
                    if toggled[name] then
                        task.wait(0.6)
                        createPlatformForChar(newChar)
                        startPlatformFollow(newChar)
                    end
                end)
            else
                stopPlatform()
            end

        elseif name == "Inf Jump" then
            if toggled[name] then
                local char = player.Character or player.CharacterAdded:Wait()
                enableInfJumpForChar(char)
                infCharConn = player.CharacterAdded:Connect(function(newChar)
                    if toggled[name] then
                        task.wait(0.6)
                        enableInfJumpForChar(newChar)
                    end
                end)
            else
                disableInfJump()
            end

        elseif name == "ESP All" then
            if toggled[name] then
                enableESP()
            else
                disableESP()
            end

        else
            -- placeholder buttons: Los Puggies, Los Spaghettis, Fragama
            -- currently they only toggle the indicator. Keep them for later logic.
        end
    end)

    yOffset = yOffset + ITEM_H
end

-- Open/close dropdown logic (directly under title bar)
local isOpen = false
local function openDropdown()
    isOpen = true
    expandLabel.Text = "-"
    local targetHeight = HEADER_H + content.Size.Y.Offset
    window.Size = UDim2.new(0, WIDTH, 0, targetHeight)
end
local function closeDropdown()
    isOpen = false
    expandLabel.Text = "+"
    window.Size = UDim2.new(0, WIDTH, 0, HEADER_H)
end

toggleOptionsBtn.MouseButton1Click:Connect(function()
    if isOpen then
        closeDropdown()
    else
        openDropdown()
    end
end)

-- Make titleBar draggable (but not toggle button)
local dragging = false
local dragStart = nil
local startPos = nil

titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        -- if click is on toggleOptionsBtn area, don't start drag (avoid conflict)
        local abs = input.Position
        local toggleAbs = toggleOptionsBtn.AbsolutePosition
        local toggleSize = toggleOptionsBtn.AbsoluteSize
        if abs.X >= toggleAbs.X and abs.X <= (toggleAbs.X + toggleSize.X) and abs.Y >= toggleAbs.Y and abs.Y <= (toggleAbs.Y + toggleSize.Y) then
            return
        end

        dragging = true
        dragStart = input.Position
        startPos = window.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        window.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- initially closed
closeDropdown()

print("✅ Phox Helper (Arcade Red) loaded — click 'Menu' to toggle the dropdown, drag the red bar to move.")
